image: python:3.5-jessie

stages:
  - build
  - sonar

cache:
  paths:
  - .pip/

variables:
  SCANER_VERSION: 3.0.3.778-linux

sonar:
  stage: sonar
  before_script:
  - apt-get --yes -qq update && apt-get --yes -qq install zip
  # Installs sonar-runner ZIP file
  - if [[ ! -d sonar-scanner-$SCANER_VERSION ]]; then
  -     wget --no-verbose https://sonarsource.bintray.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-$SCANER_VERSION.zip
  -     unzip -q sonar-scanner-cli-$SCANER_VERSION.zip
  - fi
  - sonar-scanner-$SCANER_VERSION/bin/sonar-scanner --version
  # Installs pip requirements
  - test ! -d .pip && mkdir .pip
  - pip install --cache-dir .pip/ pylint pylint-django
  - if [[ -f requirements/common.txt ]] && [[ -f requirements/constraints.txt ]]; then
  -     pip install --cache-dir .pip/ --requirement requirements/common.txt --constraint requirements/constraints.txt;
  - fi
  script:
  # Runs the sonar-runner
  - export SONAR_SCANNER_OPTS="-Xmx512m"
  - export SONAR_USER_HOME=.
  - sonar-scanner-$SCANER_VERSION/bin/sonar-scanner -Dsonar.host.url="http://ulysse.ville.tg:9000"
  cache:
    paths:
    - sonar-scanner-cli-$SCANER_VERSION.zip
    - sonar-scanner-$SCANER_VERSION/
    - .scannerwork/
  tags:
  - sonar

package:
  stage: build
  before_script:
  - pip install --cache-dir .pip/ --upgrade pip setuptools wheel
  script:
  - python setup.py sdist --formats=gztar,zip
  artifacts:
    paths:
    - dist/

pages:
  stage: build
  before_script:
  - pip install --cache-dir .pip/
      --requirement ./requirements/requirements.txt --constraint ./requirements/constraints.txt
  script:
  - pip install --cache-dir .pip/
      --requirement ./requirements/docs.txt --constraint ./requirements/constraints.txt
  - cd docs
  - make html
  - mv build/html/ public/
  artifacts:
    paths:
    - public/
